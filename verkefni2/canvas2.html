<!DOCTYPE html>
<html>
<head>
    <style type="text/css">
        #theCanvas {
            border: 1px solid #000;
        }

    </style>
    <script src="http://code.jquery.com/jquery-1.7.1.js"></script>
    <script src="kinetic-v3.6.2.min.js"></script>
    <script src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
</head>
<body>
<script type="TEXT/JAVASCRIPT">

    var shapes = [];
    var factory = createRect;

    function Rectangle(x, y) {
        this.x = x;
        this.y = y;
        this.endX = x;
        this.endY = y;
    }
    Rectangle.prototype.Draw = function (ctx) {
        ctx.strokeRect(this.x, this.y, this.endX, this.endY);
    }
    Rectangle.prototype.SetEnd = function (x, y) {
        this.endX = x;
        this.endY = y;
    }

    // Circle
    function Circle(x, y) {
        this.x = x;
        this.y = y;
        this.radius = x + y / 2;
    }
    Circle.prototype.Draw = function (ctx) {
        ctx.beginPath();
        ctx.arc(this.x, this.y, 70, 0, 2 * Math.PI, false);
        ctx.fillStyle = "#8ED6FF";
        ctx.fill();
        ctx.lineWidth = 5;
        ctx.strokeStyle = "black";
        ctx.stroke();
    }
    Circle.prototype.SetEnd = function (x, y) {
        this.endX = x;
        this.endY = y;
    }

    //Line
    function Line(x,y){
        this.x = x;
        this.y = y;
    }
    Line.prototype.Draw = function(ctx){
        ctx.moveTo(this.x,this.y);
        ctx.lineTo(this.endX,this.endY);
        ctx.stroke();
    }
    Line.prototype.SetEnd = function (x,y) {
        this.endX = x;
        this.endY = y;
    }

    // Pen
    function Pen(x, y) {
        this.points = [];

        var firstPoint =
        {
            "x":x,
            "y":y
        };

        this.points.push(firstPoint);
    }
    Pen.prototype.SetEnd = function (x, y) {
        var nextPoint =
        {
            "x":x,
            "y":y
        };
        this.points.push(nextPoint);
    }
    Pen.prototype.Draw = function (ctx) {
        ctx.beginPath();

        for (i = 0; i < this.points.length; i++) {
            //ctx.moveTo(this.points[i].x, this.points[i].y);
            ctx.lineTo(this.points[i].x, this.points[i].y);
            ctx.stroke();
        }
    }

    //Text
    function Text(x,y){
        this.x = x;
        this.y = y;
    }
    Text.prototype.SetEnd = function(x,y){
        this.endX = x;
        this.endY = y;
    }
    Text.prototype.Draw = function(ctx){
        ctx.font = "40pt Calibri";
        ctx.fillText("Hello World!", this.x, this.y);
    }

    function Redraw(ctx) {
        ctx.clearRect(0, 0, 800, 400);
        for (var i = 0; i < shapes.length; i++) {
            shapes[i].Draw(ctx);
        }
    }

    function createRect(x, y) {
        return new Rectangle(x, y);
    }
    function setRect() {
        factory = createRect;
    }

    function createCircle(x, y, radius) {
        return new Circle(x, y, radius);
    }
    function setCircle() {
        factory = createCircle;
    }

    function createPen(x, y) {
        return new Pen(x, y);
    }
    function setPen() {
        factory = createPen;
    }

    function setShape(shapeName) {
        $("#message2").text('shapeName: ' + shapeName);

        factory = function (x, y) {
            return eval("new " + shapeName + "(x,y)");
        }

    }

    function Stringify(arr) {
        return JSON.stringify(arr);
    }

    function Arrayfy(str) {

    }

    $(document).ready(function () {

        var canvas = document.getElementById("theCanvas");
        var context = canvas.getContext("2d");

        var startX = 0;
        var startY = 0;
        var mouseIsDown = false;
        /*
        var centerX = canvas.width / 2;
        var centerY = canvas.height / 2;
        var radius = 70;
        */

        $("#theCanvas").mousedown(function (e) {

            var x = e.pageX - this.offsetLeft;
            var y = e.pageY - this.offsetTop;
            startX = x;
            startY = y;

            mouseIsDown = true;

            shapes.push(factory(x, y));
            $("#message").text("mousedown x: " + x + " y: " + y + " factory: " + factory);

        });

        $("#theCanvas").mouseup(function (e) {
            mouseIsDown = false;
        });

        $("#theCanvas").mousemove(function (e) {
            if (mouseIsDown) {
                var x = e.pageX - this.offsetLeft;
                var y = e.pageY - this.offsetTop;

                var lastShape = shapes[ shapes.length - 1];

                lastShape.SetEnd(x, y);

                if (lastShape != undefined) {
                    lastShape.SetEnd(x, y);
                    Redraw(context);
                }

                $("#message").text('factory: ' + factory);
            }
        });

        $("#saveTemplate").click(function () {
            var title = prompt("Whats the name of the template?");
            if (title == "") {
                var stringifiedArray = Stringify(g_shapes);
                var param = { "user" : "dabs",
                    "name" : title,
                    "content" : stringifiedArray,
                    "template" : true
                };

            $.ajax({
                type: "POST",
                contentType: "application/json; charset=utf-8",
                url: "http://whiteboard.apphb.com/Home/Save",
                data: param,
                dataType: "jsonp",
                crossDomain: true,
                success: function (data) {
                    var arr = [{ "ID": data.ID,
                        "WhiteboardTitle": title
                    }];
                    $("#templateTemplate").tmpl(arr).appendTo("#templateSelect");
                },
                error: function (xhr, err) {
                    alert("error");
                }
            });
            }
        });

        $("#templateSelect").dblclick(function (e) {
            var item = this.options[this.selectedIndex].value;
            var param = { "id": item };
            $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                url: "http://whiteboard.apphb.com/Home/GetList",
                data: param,
                dataType: "jsonp",
                crossDomain: true,
                success: function (data) {
                    var items = JSON.parse(data.WhiteboardContents);
                    for (var i = 0; i < items.length; i++){
                        var func = eval(items[i].ClassName);
                        items[i].__proto__ = func.prototype;
                        g_shapes.push(items[i]);
                    }

                    Redraw(context);
                },
                error: function (xhr, err) {
                    alert("error:\n" + xhr + "\n" + err);
                }
            });
        });

        var param = {
            "user": "dabs",
            "template": true
        };

        $.ajax({
            type: "GET",
            contentType: "application/json; charset=utf-8",
            url: "http://whiteboard.apphb.com/Home/GetList",
            data: param,
            dataType: "jsonp",
            crossDomain: true,
            success: function (data) {
                $("#templateTemplate").tmpl(data).appendTo("#templateSelect");
            },
            error: function (xhr, err) {
                alert("error:\n" + xhr + "\n" + err);
            }
        });
    });

</script>
<canvas id="theCanvas" width="400" height="400">
    <p>No support for canvas, sorry</p>
</canvas>
<p>
<button onclick="setShape('Rectangle');">Rectangle</button>
<button onclick="setShape('Circle');">Circle</button>
<button onclick="setShape('Pen');">Pen</button>
<button onclick="setShape('Line');">Line</button>
<button onclick="setShape('Text');">Text</button>
</p>
<p>
    <select multiple="multiple" id="templateSelect">

    </select>
    <script id="templateTemplate" type="text/html">
        <option value='${ID}'>${WhiteboardTitle}</option>
    </script>
</p>
<p id="message"></p>

<p id="message2"></p>
</body>
</html>